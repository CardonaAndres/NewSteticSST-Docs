# ---------------------------------------------------
# Bloque de eventos (requerido aunque esté vacío).
events {}

http {
    # ---------------------------------------------------
    # Upstreams: definen los microservicios backend.
    # Cada upstream apunta al contenedor correspondiente en Docker.

    upstream staff_api {
        server staff:3002;              # Microservicio STAFF
    }

    upstream reports_manager_api {
        server reports-manager:3003;    # Microservicio REPORTS
    }

    # ---------------------------------------------------
    # Servidor HTTP (puerto 80) para redirigir a HTTPS
    server {
        listen 80;
        server_name api.sst.newstetic.com;

        # Fuerza siempre HTTPS
        return 301 https://$host$request_uri;
    }

    # ---------------------------------------------------
    # Servidor HTTPS (puerto 443) que expone el backend
    server {
        listen 443 ssl;
        server_name api.sst.newstetic.com;

        # ---------------------------------------------------
        # Certificados SSL emitidos por Let's Encrypt
        ssl_certificate     /etc/letsencrypt/live/api.sst.newstetic.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/api.sst.newstetic.com/privkey.pem;

        # Opciones de seguridad básicas
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        # ---------------------------------------------------
        # Configuración de CORS
        # Permite que el frontend oficial (https://sst.newstetic.com)
        # pueda consumir las APIs de backend.
        map $http_origin $cors_origin {
            default "";
            "https://sst.newstetic.com" $http_origin;   # Origen permitido
        }

        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # Respuesta inmediata para preflight requests (OPTIONS)
        if ($request_method = OPTIONS) {
            return 204;
        }

        # ---------------------------------------------------
        # Rutas hacia los microservicios

        # Microservicio STAFF
        location /API-SST/v1/staff/ {
            proxy_pass http://staff_api/;            # Envía al upstream staff_api
            proxy_set_header Host $host;             # Mantiene Host original
            proxy_set_header X-Real-IP $remote_addr; # IP real del cliente
        }

        # Microservicio REPORTS
        location /API-SST/v1/reports/ {
            proxy_pass http://reports_manager_api/;  # Envía al upstream reports_manager_api
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
